name: Deploy Production

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [master]

concurrency:
  group: production
  cancel-in-progress: false

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    # CRITICAL: Only run if CI workflow succeeded AND it's from master branch
    if: |
      github.event.workflow_run.conclusion == 'success' && 
      github.event.workflow_run.head_branch == 'master'
    environment:
      name: production
      url: https://crackmode.vercel.app
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Deploy to Vercel Production
        id: deploy
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_PRODUCTION  }}
          vercel-args: '--prod'

      - name: Create deployment status
        run: |
          echo "üéâ CrackMode deployed to production!"
          echo "üåê Production URL: ${{ steps.deploy.outputs.preview-url }}"
          echo "üì¶ Version: ${{ github.event.workflow_run.head_sha }}"
          echo "üë§ Deployed by: ${{ github.actor }}"
          echo "‚úÖ All CI checks (lint, build, test, security) passed"

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = `v${new Date().toISOString().split('T')[0]}-${context.payload.workflow_run.head_sha.substring(0, 7)}`;
            
            github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `Production Deploy ${tag}`,
              body: `Deployed to production
              
              üåê URL: ${{ steps.deploy.outputs.preview-url }}
              üì¶ Commit: ${context.payload.workflow_run.head_sha}
              üë§ Author: ${{ github.actor }}
              ‚úÖ All CI checks passed`,
              draft: false,
              prerelease: false
            })